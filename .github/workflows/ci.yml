# Copyright 2023 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# GitHub action that runs https://github.com/adRise/update-pr-branch on each push to
# `main`. `update-pr-branch` will pick the oldest PR (by creation date) that is approved
# with auto-merge enabled and update it to the latest `main`, forming a best-effort queue
# of approved PRs.

name: CI

on:
  push:
    branches:
      - "main"
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@1.91.1
        with:
          components: "clippy, rustfmt"
      - uses: Swatinem/rust-cache@v2

      # make sure all code has been formatted with rustfmt and linted with clippy
      - name: rustfmt
        run: cargo fmt -- --check --color always

      # run clippy to verify we have no warnings
      - run: cargo fetch
      - name: cargo clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

  validate-proto-bufs:
    name: Validate proto bufs
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
            submodules: true
      - run: cargo run -p proto-gen -- validate

  test:
    name: Test
    runs-on: ubuntu-24.04
    env:
      RUST_BACKTRACE: "1"
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@1.91.1
      - uses: Swatinem/rust-cache@v2
        with:
          prefix-key: "bust"
      - name: Install nextest
        run: curl -LsSf https://get.nexte.st/latest/linux | tar zxf - -C ${CARGO_HOME:-~/.cargo}/bin
      - name: Build
        run: cargo build -p qt -p quilkin -p quilkin-xds --tests
      - run: cargo nextest --profile ci run --no-tests=pass -p qt -p quilkin -p quilkin-xds -p corrosion-tests
      - name: Validate Quilkin's clap arguments
        run: |
          set +e # don't fail on error, we expect the command to fail since we aren't providing arguments
          cargo run -p quilkin
          if [ $? -ne 255 ]; then
            echo "::error ::clap arguments seem to have an error"
            exit 1
          fi
          exit 0

  build-aarch64:
    name: Build aarch64
    strategy:
      matrix:
        include:
          - target: aarch64-unknown-linux-gnu
    runs-on: ubuntu-24.04
    env:
      RUST_BACKTRACE: "1"
    steps:
      - uses: actions/checkout@v6
      - uses: Swatinem/rust-cache@v2
      - name: Install cross
        run: |
          # Cross has not released a binary in over 2 years, so...we install from git, which is bad, but at least
          # we pin it to a specific revision to avoid random breakage
          cargo install --git https://github.com/cross-rs/cross --rev 19bc73f cross
      - name: Build
        run: cross build --target ${{ matrix.target }} -p qt -p quilkin -p quilkin-xds --tests
      # We can't test, io_uring_setup is not implemented in qemu as of now
      # - name: Build
      #   run: cross test --target ${{ matrix.target }} -p qt -p quilkin -p quilkin-xds

  build:
    name: Build
    strategy:
      matrix:
        os:
          - macos-14
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
      - uses: dtolnay/rust-toolchain@1.91.1
      - uses: Swatinem/rust-cache@v2
      - run: cargo fetch
      - run: cargo build

  deny-check:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - name: deny check
        uses: EmbarkStudios/cargo-deny-action@v2

  test_success:
    runs-on: ubuntu-24.04
    needs: [lint, test, build, build-aarch64, deny-check, validate-proto-bufs]
    steps:
      - run: echo "All test jobs passed"
